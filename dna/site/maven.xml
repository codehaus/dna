<?xml version="1.0"?>
<project default="main"
    xmlns:j="jelly:core"
    xmlns:maven="jelly:maven"
    xmlns:ant="jelly:ant"
    xmlns:velocity="jelly:org.apache.commons.jelly.tags.velocity.VelocityTagLibrary">

    <goal name="main">
        <attainGoal name="build"/>
    </goal>

    <goal name="build">
        <attainGoal name="site:generate"/>
    </goal>

    <goal name="deploy">
        <attainGoal name="site:deploy"/>
    </goal>

    <preGoal name="site:generate">
	    <attainGoal name="aggregate-components"/>
    </preGoal>

    <!-- Build all components sites and aggregate them under site docs -->
	<!-- Note that this goal only works if executed in the site/ dir
		 If one tries to executed via a high-level reactor the
		 relative path in the basedir will not yield the correct path
		 to the components' projects.
	-->
    <goal name="aggregate-components">
        <echo message="Aggregate components"/>
        <attainGoal name="aggregate-components-${dna.components.aggregateby}"/>
    </goal>

    <goal name="aggregate-components-site">
        <echo message="Aggregate components by site"/>
        <!-- Generate navigation -->
        <ant:mkdir dir="${maven.build.dir}/templates"/>
        <j:file name="${maven.build.dir}/templates/navigation.links"
        		omitXmlDeclaration="true"
        		prettyPrint="true">
	        <links>
	            <item href="http://dna.jcontainer.org/api" name="API"/>
	            <item href="http://dna.jcontainer.org/impl" name="Default Implementation"/>
	            <item href="http://dna.jcontainer.org" name="DNA"/>
	            <item href="http://jcontainer.org" name="JContainer"/>
	            <item href="http://codehaus.org" name="Codehaus"/>
	        </links>
        </j:file>
        <j:file name="${maven.build.dir}/templates/navigation.components"
        		omitXmlDeclaration="true"
        		prettyPrint="true">
	        <menu name="Components">
	            <item href="http://dna.jcontainer.org/api" name="API"/>
	            <item href="http://dna.jcontainer.org/impl" name="Default Implementation"/>
	        </menu>
        </j:file>
	    <attainGoal name="generate-navigation"/>
        <!-- Generate component sites -->
        <maven:reactor
            basedir="../"
            includes="api/project.xml,impl/project.xml"
            goals="site:generate"
            banner="Generate site"
            ignoreFailures="false" />
        <ant:copy todir="target/docs/api">
            <ant:fileset dir="../api/target/docs"/>
        </ant:copy>
        <ant:copy todir="target/docs/impl">
            <ant:fileset dir="../impl/target/docs"/>
        </ant:copy>
    </goal>

    <goal name="aggregate-components-source">
        <echo message="Aggregate components by source"/>
        <!-- Generate navigation -->
        <ant:mkdir dir="${maven.build.dir}/templates"/>
        <j:file name="${maven.build.dir}/templates/navigation.links"
        		omitXmlDeclaration="true"
        		prettyPrint="true">
	        <links>
	            <item href="http://dna.jcontainer.org" name="DNA"/>
	            <item href="http://jcontainer.org" name="JContainer"/>
	            <item href="http://codehaus.org" name="Codehaus"/>
	        </links>
        </j:file>
        <j:file name="${maven.build.dir}/templates/navigation.components"
        		omitXmlDeclaration="true"
        		prettyPrint="true">
        </j:file>
	    <attainGoal name="generate-navigation"/>
        <!-- Aggregates sources -->
        <ant:mkdir dir="${maven.build.dir}/aggregate-src/java"/>
        <ant:copy todir="${maven.build.dir}/aggregate-src/java">
            <ant:fileset dir="../api/src/java"/>
            <ant:fileset dir="../impl/src/java"/>
        </ant:copy>
        <ant:mkdir dir="${maven.build.dir}/aggregate-src/test"/>
        <ant:copy todir="${maven.build.dir}/aggregate-src/test">
            <ant:fileset dir="../api/src/test"/>
            <ant:fileset dir="../impl/src/test"/>
        </ant:copy>
    </goal>

	<!-- Generate navigation using template -->
    <goal name="generate-navigation">
        <echo message="Generation navigation.xml"/>
        <ant:mkdir dir="${maven.build.dir}/generated-xdocs"/>
        <ant:copy todir="${maven.build.dir}/templates">
       		<ant:fileset dir="templates"/>
        </ant:copy>
        <velocity:merge
          name="${maven.build.dir}/generated-xdocs/navigation.xml"
          basedir="${maven.build.dir}/templates"
          template="navigation.xml"/>
    </goal>

</project>
